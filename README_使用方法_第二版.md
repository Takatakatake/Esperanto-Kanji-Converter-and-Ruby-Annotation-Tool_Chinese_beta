# Esperanto-Hanzi-Converter-and-Ruby-Annotation-Tool-Chinese

以下是一份面向中国大陆地区图形界面（GUI）用户的**详细使用说明书**，旨在帮助您充分理解并熟练使用这套由四个 Python 文件组成的 Streamlit 应用程序。该应用由以下几个主要部分构成：

1. **`main.py`**：Streamlit 主应用文件（也是用户最先接触和主要操作的页面）。  
2. **`用于生成世界语文本(含汉字)替换的 JSON 文件工具.py`**：这是一个放在 `pages/` 目录中的 Streamlit 页面脚本，用来**生成**（或合并）大规模的“世界语→汉字或注释”替换规则 JSON 文件。  
3. **`esp_text_replacement_module.py`**：核心替换模块，包含对世界语文本进行多种形式（带 x、带 ^、带上标等）的字母转换、局部替换、占位符管理以及并行处理的函数。  
4. **`esp_replacement_json_make_module.py`**：在生成 JSON 文件环节用到的模块（与第 3 个文件的功能部分重叠），主要在“生成替换用 JSON”时对词根进行细粒度拆分、并行构建、添加后缀等操作。

本说明将分为若干部分，**由浅入深**介绍该工具的使用方法、页面交互流程、主要功能与注意事项，帮助中文用户快速上手。

---

## 目录

1. [整体使用流程概览](#整体使用流程概览)  
2. [主页面 `main.py` 的使用方法](#主页面-mainpy-的使用方法)  
   1. [选择和加载替换 JSON](#选择和加载替换-json)  
   2. [并行处理的高级配置](#并行处理的高级配置)  
   3. [输入世界语文本](#输入世界语文本)  
   4. [选择输出格式（HTML、括号等）](#选择输出格式html括号等)  
   5. [世界语特殊字母的呈现形式](#世界语特殊字母的呈现形式)  
   6. [下载转换结果](#下载转换结果)  
3. [“生成世界语文本(含汉字)替换的 JSON 文件工具”页面](#生成世界语文本含汉字替换的-json-文件工具页面)  
   1. [此页面的作用](#此页面的作用)  
   2. [主要操作步骤](#主要操作步骤)  
   3. [CSV 与 JSON 的准备](#csv-与-json-的准备)  
   4. [并行处理配置与生成最终 JSON](#并行处理配置与生成最终-json)  
   5. [如何下载生成的 JSON](#如何下载生成的-json)  
4. [底层替换原理简述：`esp_text_replacement_module.py` 与 `esp_replacement_json_make_module.py`](#底层替换原理简述)  
5. [常见问题与注意事项](#常见问题与注意事项)  
   1. [占位符的用途](#占位符的用途)  
   2. [局部替换 `@...@` 与跳过替换 `%...%` 的区别](#局部替换-与跳过替换-的区别)  
   3. [可能的文本编码问题](#可能的文本编码问题)  
   4. [JSON 文件的体积与处理时长](#json-文件的体积与处理时长)  
6. [总结与推荐使用方式](#总结与推荐使用方式)

---

<a name="整体使用流程概览"></a>

## 1. 整体使用流程概览

**这个应用的核心目的**是：  

- 将一段或多段**世界语文本**，按照您定义（或默认提供）的“世界语词根 → 汉字/注释”规则，**自动生成带有汉字标注或 Ruby 标注**的结果，供您在前端网页中查看、复制或下载。  
- 另外，提供了一个**生成/合并替换规则 JSON** 的辅助页面，方便您自行维护大规模的“词根-汉字”对照关系，并让 `main.py` 在转换时使用这份定制的规则。

在实际使用中，常见的操作流程通常为：

1. **先配置好替换规则 JSON**（如果您需要自定义大量词根与对应汉字，可以先到“生成 JSON”页面去生成 / 合并一份 JSON）；如果您只是测试，或者词根数据不多，也可直接用默认 JSON。  
2. **返回主页面 `main.py`**，选择加载该 JSON（或者使用默认 JSON），输入或上传所需转换的世界语文本。  
3. 在主页面选择所需的**输出格式**（如 HTML + Ruby、或“括号(号)格式”、只保留汉字等），并**提交**，得到转换结果。  
4. **预览**转换结果，若满意，则可**下载**为 HTML（或其他格式）。

对于希望深入研究、或做大规模替换（上万行世界语文本）的人士，也可使用**并行处理**（多进程）加速替换过程。

---

<a name="主页面-mainpy-的使用方法"></a>

## 2. 主页面 `main.py` 的使用方法

`main.py` 即是在 Streamlit Cloud 或本地运行后，**第一眼**呈现给用户的界面。它的主要功能是：

- **加载替换规则 JSON**（默认或者用户上传）  
- **输入世界语文本**（手动输入、多行粘贴或上传文本文件）  
- 选择输出形式（HTML + ruby、带汉字替换的 HTML、括号式标注、单纯替换等）  
- 设置世界语特殊字母在结果中的表现形式（`上标形式`、`x` 形式、`^` 形式）  
- **下载**转换后的文本（通常为 HTML 文件）  

下图所示(示意)的交互控件基本都在 `main.py` 中实现。

下面将**按界面上从上到下的顺序**进行说明。

---

<a name="选择和加载替换-json"></a>

### 2.1. 选择和加载替换 JSON

在页面中，您会看到一个**单选按钮**（Radio），让您**选择**：  

- “使用默认 JSON”  
- “上传 JSON 文件”

若您选择“使用默认 JSON”，系统会直接加载内置于本地目录（`./Appの运行に使用する各类文件/...`）下的那份默认合并 JSON。  

- 如果加载成功，会提示 “成功读取默认 JSON 文件”。  
- 如果目录不正确，或文件损坏，会报错。

若您想使用**自定义**的规则文件，请切换到“上传 JSON 文件”，并点击**上传**：  

- 请选择 `.json` 类型文件（里面必须包含与默认 JSON 相同的结构，如“全域替换用のリスト(列表)型配列(replacements_final_list)”等三个字段）。  
- 上传成功后，系统会提示“已成功读取上传的 JSON 文件”。

**注意**：若您尚未上传任何 JSON 文件，则无法进行下一步操作，系统会给出警告并停止。

**用途**：这份 JSON 决定了**哪些世界语词根**会被自动替换成**什么样的汉字或注释**。例如，“amik” → “<ruby>amik<rt>友</rt></ruby>”，或者 “amik” → “友(amik)” 等等。

---

<a name="并行处理的高级配置"></a>

### 2.2. 并行处理的高级配置

紧接着，页面会出现一个**可折叠**的高级选项，“是否使用并行处理（多进程）”。  

- 对大文本（例如几千行以上）进行处理时，并行处理可能**显著**提升速度。  
- 但若您的文本较短，启用并行处理会带来一些额外开销，也有可能并不会更快。  
- 若您对并行处理不熟悉，可**默认不勾选**。

在勾选“使用并行处理”后，可选择进程数量（`num_processes`）。  

- 一般设置为 2~4（或 2~6）。数值越高，CPU 占用越大，但可能减少处理总时长。

---

<a name="输入世界语文本"></a>

### 2.3. 输入世界语文本

此部分是**核心**：用户需要提供要被转换的世界语文本。

**有两种方式**：

1. **手动输入**：如果您的文本不多，只需在页面的多行文本框里直接粘贴或键入即可。  
2. **上传文件**：如果您有一份 `.txt`、`.csv` 或 `.md`（UTF-8 编码）的文件，里面全部是世界语文本，可点击“上传文件”并选择对应文件。系统会自动读取并显示一条提示信息 “文件已读取”。  

如无文本输入，系统会提示您“尚未上传文本文件，无法继续执行”或者“请手动输入文本”并停止。

---

<a name="选择输出格式html括号等"></a>

### 2.4. 选择输出格式（HTML、括号等）

在主界面有一个下拉菜单/下拉框（`st.selectbox`），其选项通常如下：

- **HTML格式_Ruby文字_大小调整**  
  - 生成带 `<ruby>...</ruby>` 结构的 HTML，并会根据世界语词根与汉字的相对长度自动微调 `<rt>` 字体大小。  
- **HTML格式_Ruby文字_大小调整_汉字替换**  
  - 和上面类似，但把世界语词根放在 `<rt>` 里，把汉字放在 `<ruby>` 的主体里；也会做字体大小的动态适配。  
- **HTML格式**  
  - 生成最简单的 `<ruby>词根<rt>汉字</rt></ruby>` 结构，字体大小统一；世界语在上，汉字在下。  
- **HTML格式_汉字替换**  
  - 也是 `<ruby>汉字<rt>世界语</rt></ruby>` 这种呈现方式，汉字在上，世界语词根在下面。  
- **括弧(号)格式**  
  - 生成普通文本，形如“Hello(mondo)”，即 `主词(注释)`。  
- **括弧(号)格式_汉字替换**  
  - 形如“世界(Hello)”，将汉字与世界语位置调换。  
- **替换后文字列のみ(仅)保留(简单替换)**  
  - 只保留替换后的字符串，不带任何原词根或 Ruby 标签。若替换后是汉字，就只剩汉字了。

**建议**：  

- 如果希望后续在网页中**直接呈现 Ruby**，使用前几个 HTML 选项尤佳；  
- 如果想在普通文档或聊天里附带简单注释，可用“括弧(号)格式”；  
- 如果只想要“世界语词根 → 汉字”**直接替换**成汉字，不保留原单词，可以选最后一种。

---

<a name="世界语特殊字母的呈现形式"></a>

### 2.5. 世界语特殊字母的呈现形式

在提交表单之前，还可以选择世界语的特殊字母呈现方式（Radio 按钮）：

- **上标形式**（ĉ 显示成 č，或者近似地显示为带上标符号）  
- **x 形式**（ĉ → cx, ĝ → gx 等）  
- **^ 形式**（ĉ → c^, ĝ → g^ 等）

这主要是为了兼容一些不支持 Unicode 或特定情况下需要 `cx, gx, hx` 等形式的需求。

**具体原理**：  

- 默认输入文本可能含有 `c^`, `cx` 或者真正的 `ĉ` 等形式，这里会统一处理；在最后输出时，若您选择了“x 形式”，系统会把 `ĉ` 重新替换回 `cx`。同理，也可以转成 `c^` 等。

---

<a name="下载转换结果"></a>

### 2.6. 下载转换结果

当您**点击提交**后，系统会执行替换，生成一个名为 `processed_text` 的结果字符串，并在页面上显示。此时您可以：

1. **预览**（若是 HTML 格式，页面通常会给出 2 个标签页：“HTML 预览”+“HTML 源码”）：  
   - 在“HTML 预览”里以富文本方式查看替换后的效果；  
   - 在“HTML 源码”里以纯文本方式查看真实的 `<ruby>`/`<rt>` 标签内容。  
2. **下载**：点击“下载转换结果 (HTML)”按钮，即可把这段处理后的文本打包成 `.html` 文件下载到本地。

在文本行数过多时，系统只会展示前若干行 + 后 3 行作为预览，提示您“文本行数较多，只显示部分内容”，但**下载**的文件仍包含**全部**内容。

---

<a name="生成世界语文本含汉字替换的-json-文件工具页面"></a>

## 3. “用于生成世界语文本(含汉字)替换的 JSON 文件工具”页面

Streamlit 的多页面功能让我们可以在侧边栏或顶部“Pages”里进入这个页面。它的文件名是  
**`用于生成世界语文本(含汉字)替换的 JSON 文件工具.py`**  
该页面专门用于**大型替换规则**（JSON）的生成或合并。

<a name="此页面的作用"></a>

### 3.1. 此页面的作用

默认情况下，`main.py` 使用的 JSON 替换规则其实是**已经做好的**，但如果您有**自己的一大批词根-汉字对应关系**（可能几千甚至上万条），并希望将这些对应关系整合到 JSON 中让 `main.py` 使用，就可以通过这个页面来**自动生成或合并**。

此页面内也会**读取 CSV 文件、若干 JSON 设置**，最后生成一份新的**合并后的 JSON** 文件（涵盖三大部分：全域替换列表、局部替换列表、二字词根替换列表）。

在实际应用中，这样的大 JSON 文件可能有 20~50MB，甚至更大。完成后，就能被主页面 `main.py` 直接加载，从而让后续文本转换支持海量词汇。

---

<a name="主要操作步骤"></a>

### 3.2. 主要操作步骤

在“生成 JSON”页面里，您会看到这些功能板块：

1. **示例文件下载**：一些演示用的 CSV、JSON、Excel 文件的下载按钮；帮助您了解所需文件格式  
2. **第一步：准备 CSV 文件**  
3. **第二步：准备词根分解法 / 自定义替换 JSON 文件**  
4. **第三步：并行处理（高级设置）**  
5. **生成并下载替换用 JSON 文件**  

---

<a name="csv-与-json-的准备"></a>

### 3.3. CSV 与 JSON 的准备

1. **CSV 文件**：  
   
   - 在“第一步：准备 CSV 文件”中选择“上传 CSV”或“使用默认 CSV”。  
   - CSV 文件最基础的格式是**两列**：第一列为世界语词根，第二列为对应的**汉字**或**中文释义**。  
   - 如果您上传 CSV，会自动把里面的 `c^`, `cx` 等转换到**统一的字上符**形式再读入。  

2. **词根分解法 JSON**：  
   
   - 在“第二步”里选择“上传 JSON”或“使用默认 JSON”。  
   - 这份 JSON 用于指定某些复杂词根的**拆分方式**，或者**排除不需要替换的词**，或者指示程序给某些词加上特定后缀。  
   - 若没有特殊需求，可使用示例 / 默认文件。

3. **自定义替换后文字 JSON**：  
   
   - 同样在“第二步”里设置。  
   - 这里可以对部分词根做更加细粒度的控制，比如“某个单词一定要替换成其他非常规汉字”，或者添加一些特别标记。  
   - 一般情况下并不一定需要（如果 CSV 已经涵盖了大部分常见词根）。

---

<a name="并行处理配置与生成最终-json"></a>

### 3.4. 并行处理配置与生成最终 JSON

在“第三步”可折叠选项中，您可以选择是否**启用并行处理**、以及进程数量（`num_processes`）。与 `main.py` 中类似，大规模构建 JSON 时，启用多进程可加速处理。

然后，您会看到一个**大按钮**：“生成并下载替换用 JSON 文件”。  

- 点击后，应用会执行繁琐的词根匹配、并行替换、优先级计算等逻辑（即 `esp_replacement_json_make_module.py` 里的那些函数），将 CSV + 自定义 JSON + 内置词典数据**合并**到一份最终的**三合一 JSON** 中。  
- 过程可能需要**数秒到几分钟**（取决于词根数量、CPU 核心数等）。  
- 生成成功后，页面底部会出现“下载生成的（合并三份）替换 JSON 文件”的按钮，让您将 `.json` 文件保存到本地。

---

<a name="如何下载生成的-json"></a>

### 3.5. 如何下载生成的 JSON

点击“下载生成的（合并三份）替换 JSON 文件”后，即可直接得到 `.json`。  

- 文件名类似：`世界语文本替换用_合并3个JSON文件.json`。  
- 之后，回到 `main.py` 时，只需在 “上传 JSON 文件” 处把该 `.json` 上传，即可使用这一套规则来执行文本转换。

---

<a name="底层替换原理简述"></a>

## 4. 底层替换原理简述：`esp_text_replacement_module.py` 与 `esp_replacement_json_make_module.py`

从界面上，用户只需要点击按钮即可完成替换。但底层实际有很多函数来处理各种情况。这里简要介绍几个**关键概念**，帮助您在遇到问题或想做高级自定义时能更好地理解流程。

1. **世界语字符转换**  
   
   - 在替换开始之前，会先把所有 `cx`、`c^` 等不同格式的世界语字母统一成 `ĉ`（即“字上符”形式）。这样才能保证后续匹配词根的准确性。  
   - 最终输出时，再根据用户选择把 `ĉ` 转回 `cx`、`c^` 或者保留 `ĉ`。

2. **占位符（Placeholder）**  
   
   - 在大规模替换中，如果直接做“文本替换”，有可能发生“二次替换”或“串联干扰”。  
   - 本工具先把匹配到的文本替换成**独特的占位符**（如 `$Bv3#` 之类），再在最后一次性把占位符恢复成对应的目标文本（如 `<ruby>xxx<rt>xxx</rt></ruby>`）。  
   - 这样能避免同一个片段在替换后又被识别成其他词根，或者被重复处理。

3. **%...% 跳过替换**  
   
   - 如果在原文中写了 `%内容%`，则程序会在正式替换前，把它提取出来并用占位符替换，确保这部分文本**不参加**任何替换。

4. **@...@ 局部替换**  
   
   - 相比 `%...%` 跳过替换，**@...@** 表示**仅使用指定的“局部替换列表”**来处理这部分文本（一般是和 CSV 的简易列表对应）。  
   - 例如您只想对“@单句@”里出现的词进行单独处理，而不走全局规则，就可以这样做。

5. **2 字母词根**  
   
   - 世界语有一些非常短的词根或前后缀，如 `al`, `du`, `am`, `ar` 等可能只有 2 个字母。为防止它们被当成更长词根的一部分或者被误匹配，需要**单独**处理。  
   - 因此有 `replacements_list_for_2char` 之类的数据结构来匹配这些短词根。

6. **并行处理**  
   
   - 当用户勾选“并行处理”时，程序会把文本按行数分块，分派给不同 CPU 核心进行替换，最后拼合结果。这大幅加快大文件的处理速度。

7. **后缀添加与优先级**（只在生成 JSON 时体现）  
   
   - 世界语有动词后缀 `-as`, `-is`, `-os`, `-us` 等，也有名词 `-o`、形容词 `-a`、副词 `-e` 等。生成 JSON 时会自动尝试“词根 + 后缀”的组合，并计算优先级（越长的字符串在替换中优先级越高，避免比如“amiko”先把“am”换掉了）。  
   - 最终就能覆盖到更多实际场景的单词。

---

<a name="常见问题与注意事项"></a>

## 5. 常见问题与注意事项

<a name="占位符的用途"></a>

### 5.1. 占位符的用途

如上文所述，用占位符来防止**重复替换**或**交叉覆盖**。因此，如果您发现替换完结果中还残留一些奇怪的字符（比如 `$placeholder123$` 没被替换回去），极有可能是：  

- JSON 中出现了语法错误或不完整的 “(old, new, placeholder)” 三元组  
- 或者替换流程中断了  
- 或者文本中存在与占位符格式**相同**的字符串，导致冲突。

您可重新检查或在“生成 JSON”页面仔细排查 CSV / JSON 是否有冲突条目。

---

<a name="局部替换-与跳过替换-的区别"></a>

### 5.2. 局部替换 `@...@` 与跳过替换 `%...%` 的区别

- **`%...%` 跳过替换**：本段文本**完全不会被任何替换规则**影响，最后原样输出。如果想保留某些原文不被动，比如代码片段、日期等，可用 `%...%`。  
- **`@...@` 局部替换**：对 `@xxx@` 中的文本，只应用“局部替换列表”（即 CSV 里的那些简易或局部词根替换），而**不使用**大规模替换规则。这样可以把某些词汇仅在特定语境下做特殊处理；或者想进行**最小替换**。

这两种都可以嵌在原文里，以避免全局替换失控。

---

<a name="可能的文本编码问题"></a>

### 5.3. 可能的文本编码问题

- 如果您上传的文件**不是 UTF-8** 编码，有时会出现“无法解码”或“乱码”。请在上传前确认文本编码为 UTF-8。  
- 下载后的 HTML，如果浏览器打开出现乱码，可查看文件头 `<meta charset="UTF-8">` 是否正常，也可手动切换浏览器编码为 UTF-8。

---

<a name="json-文件的体积与处理时长"></a>

### 5.4. JSON 文件的体积与处理时长

若您**生成了几万条词根** + **自动生成后缀组合**，JSON 体积可能轻松达到 50MB 甚至更多。  

- 加载这个 JSON 时，`main.py` 需耗时 1~2 秒或更长；  
- 并行处理长文本时内存占用也会增大。

如无必要，请只保留常用词根或常用组合；或者分批处理较小的 JSON。

---

<a name="总结与推荐使用方式"></a>

## 6. 总结与推荐使用方式

**推荐的典型使用场景**：  

1. 如果您只是想简单把世界语文本转换成**带汉字注释**的可读形式，可以：  
   - 打开 `main.py`  
   - 选择“使用默认 JSON”  
   - 在文本框中粘贴世界语内容  
   - 勾选或不勾选“使用并行处理”  
   - 提交，下载结果。  
2. 如果您有自己的**大批量词根**或**想要定制**替换规则：  
   - 打开 `pages/用于生成世界语文本(含汉字)替换的 JSON 文件工具.py`  
   - 上传您的 CSV（或使用默认 CSV）  
   - 如有更高级拆分/后缀需求，则上传对应的 JSON  
   - 点击“生成并下载替换用 JSON 文件”  
   - 回到 `main.py`，选择“上传 JSON 文件”，并使用这份新生成的 JSON  
   - 进行转换。

通过以上流程，您可以灵活地**建立自己的世界语→汉字(或中文注释)映射关系**，并在 GUI 上轻松查看、下载最终排版好的文本。

---

### 最后的提示

- Streamlit 的界面若出现加载缓慢或进程报错（尤其启用多进程时），请耐心等待或在本地（命令行）运行并**调低**进程数。  
- 生成的 HTML 如果涉及大量 `<ruby>` 嵌套，请在浏览器中查看以确认效果。  
- 如果您还需要对汉字进一步加注拼音或日语假名，可以再做二次处理——本工具暂时仅侧重于“世界语词根→汉字/注释”。

祝您使用顺利！若有更多问题，可查看每个脚本顶部的注释或深入阅读源码中函数的说明。希望本工具能帮助更多中文世界的世界语爱好者，轻松实现世界语文本的汉字化或注释化。  

---

（完）
